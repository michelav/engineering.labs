FROM python:3.8.1-slim

ARG GCP_CREDS_JSON_BASE64

ENV MLFLOW_HOME /opt/mlflow
ENV MODEL_STORE=${MLFLOW_HOME}/model_store
ENV MLFLOW_TRACKING_URI=http://35.185.111.8:5000

ENV GCP_CREDS_JSON_BASE64_ENV=${GCP_CREDS_JSON_BASE64}
ENV GOOGLE_APPLICATION_CREDENTIALS=${MLFLOW_HOME}/gcp.json

ENV MODEL_NAME=/BertModel/4

COPY requirements-torchserve.txt requirements.txt /tmp/
RUN mkdir -p ${MLFLOW_HOME}/scripts && \
    mkdir -p ${MODEL_STORE} && \
    echo "${GCP_CREDS_JSON_BASE64_ENV}"| base64 --decode > "${GOOGLE_APPLICATION_CREDENTIALS}" && \
    mkdir -p /usr/share/man/man1/ && \
    apt-get update && apt-get install --no-install-recommends -y openjdk-11-jre-headless && \
    apt-get clean -y -qq && apt-get autoremove -y -qq && \
    rm -rf /var/lib/apt/lists/* && \
    pip install --no-cache-dir -r /tmp/requirements.txt -r /tmp/requirements-torchserve.txt -f https://download.pytorch.org/whl/torch_stable.html
    
COPY entrypoints/torchserve.sh ${MLFLOW_HOME}/scripts/run.sh

# TODO: This should be taken from MLFlow
COPY news_classifier.py ${MLFLOW_HOME}/
COPY news_classifier_handler.py ${MLFLOW_HOME}/

WORKDIR ${MLFLOW_HOME}

EXPOSE 7070
EXPOSE 7071
EXPOSE 8080
EXPOSE 8081
EXPOSE 8082

CMD "./scripts/run.sh"